version: '3.8'

services:
  # Data processing service (DBT)
  dbt:
    build:
      context: ./dbt
      dockerfile: Dockerfile
    volumes:
      - ./dbt:/app
      - ./data/exports:/data/exports
    environment:
      - DBT_ORACLE_USER=${DBT_ORACLE_USER}
      - DBT_ORACLE_PASSWORD=${DBT_ORACLE_PASSWORD}
      - DBT_ORACLE_HOST=${DBT_ORACLE_HOST}
      - DBT_ORACLE_PORT=${DBT_ORACLE_PORT}
      - DBT_ORACLE_SERVICE=${DBT_ORACLE_SERVICE}
      - DBT_ORACLE_SCHEMA=${DBT_ORACLE_SCHEMA}
    command: tail -f /dev/null # Keep container running for manual dbt execution

  # Ollama LLM service - optimized for Apple Silicon (M2)
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    environment:
      - OLLAMA_ENABLE_METAL=1  # Enable Metal acceleration for Apple Silicon
    # No NVIDIA GPU requirements - using Apple Metal instead

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./data/exports:/data/exports
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CSV_DIR=/data/exports
      - TASKS_CSV=tasks_daily.csv
      - LLM_PROVIDER=ollama
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3:8b-instruct}  # Better model for M2 with 32GB RAM
      - LLM_ENABLED=${LLM_ENABLED:-True}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,https://tasking-monitor.example.com}
    depends_on:
      - dbt
      - ollama

  # React Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=${API_URL:-http://localhost:8000/api}
    depends_on:
      - backend

  # Scheduled Jobs Service
  scheduler:
    build:
      context: ./scheduler
      dockerfile: Dockerfile
    volumes:
      - ./dbt:/app/dbt
      - ./data/exports:/data/exports
    environment:
      - DBT_ORACLE_USER=${DBT_ORACLE_USER}
      - DBT_ORACLE_PASSWORD=${DBT_ORACLE_PASSWORD}
      - DBT_ORACLE_HOST=${DBT_ORACLE_HOST}
      - DBT_ORACLE_PORT=${DBT_ORACLE_PORT}
      - DBT_ORACLE_SERVICE=${DBT_ORACLE_SERVICE}
      - DBT_ORACLE_SCHEMA=${DBT_ORACLE_SCHEMA}
    depends_on:
      - dbt

volumes:
  data:
  ollama_data:
